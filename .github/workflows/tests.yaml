---
name: Tests
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_call:

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Checkout source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # pin@5.5.0
        with:
          go-version: 1.24.3

      - name: Run linter
        run: make lint

      - name: Run unit tests
        run: make unit-test

      - name: Read coverage from file
        id: coverage
        run: |
          if [[ -f coverage.txt ]]; then
            TOTAL_LINE=$(grep '^total:' coverage.txt | tail -1)
            COVERAGE=$(echo "$TOTAL_LINE" | grep -Eo '[0-9]+\.[0-9]+%')
            echo "COVERAGE=${COVERAGE:-Not found}" >> "$GITHUB_ENV"
          else
            echo "COVERAGE=Not found" >> "$GITHUB_ENV"
          fi

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # pin@v2.8.2
        with:
          message: |
            ðŸ§ª **Test Coverage Report**
            ```
            ${{ env.COVERAGE }}
            ```